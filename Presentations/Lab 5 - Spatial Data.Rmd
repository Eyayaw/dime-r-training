---
title: "Spatial Data in R"
subtitle: "R for Stata Users"
date: "November-December 2018"
author: "Luiza Andrade, Leonardo Viotti & Rob Marty "
output:
  beamer_presentation:
    #theme: "Pittsburgh"
    theme: "Madrid"
    colortheme: "whale"
    fonttheme: "default"
    toc: false
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# GIS Overview

## GIS Data: Vector Data
One of the main GIS data types is vector data. Vectors (also called shapefiles) consist of points, lines and polygons. These shapes are attached to a dataframe, where each row corresponds to a different spatial element.

```{r fig.align="center", echo=F}
knitr::include_graphics("img/Attribute_Table.png", dpi = 400)
```

## GIS Data: Raster Data

The second main GIS data type is raster data. Rasters are spatially-referenced grids, where each grid has a value associated with it.

```{r fig.align="center", echo=F}
knitr::include_graphics("img/raster_r_example.png", dpi = 400)
```


## Coordinate Reference Systems

__Coordinate reference systems__ map pairs of numbers to a location.

* __Geographic Coordinate Systems__ live on a sphere; here, the units are in decimal degrees

    + Using the WGS84 coordinate system the World Bank MC building is located at 38.89 degrees latitude and -77.04 degrees longitude.
    
* __Projected Coordinate Systems__ project the earth onto a flat surface. This [distorts](http://geoawesomeness.com/5-tools-will-let-master-map-projections/) the earth in some way (shape, area, distance or direction)

    + Using to the World Mercator projection, the World Bank is located 4680364.64 north and -8576320.73 east.

```{r fig.align="center", echo=F}
knitr::include_graphics("img/coordinate_systems.jpg", dpi = 220)
```

## Make a Map

```{r, eval=T, echo=F}
finalData <- "C:/Users/wb521633/Documents/GitHub/dime-r-training/DataWork/DataSets/Final"
```


```{r, eval=F, echo=F}
library(rworldmap)
library(rgdal)

finalData <- "C:/Users/wb521633/Documents/GitHub/dime-r-training/DataWork/DataSets/Final"
whr <- read.csv(file.path(finalData,"whr_panel.csv"), header = T)
whr <- subset(whr, year == 2015)
worldmap <- getMap(resolution="low")
worldmap <- subset(worldmap, select=c(ADMIN, REGION, POP_EST, GDP_MD_EST))

whr$country[!whr$country %in% worldmap$ADMIN]

worldmap$ADMIN <- as.character(worldmap$ADMIN)
worldmap$ADMIN[worldmap$ADMIN %in% "United States of America"] <- "United States"
worldmap$ADMIN[worldmap$ADMIN %in% "Northern Cyprus"] <- "North Cyprus"
worldmap$ADMIN[worldmap$ADMIN %in% "Hong Kong S.A.R."] <- "Hong Kong"
worldmap$ADMIN[worldmap$ADMIN %in% "Republic of Serbia"] <- "Serbia"
worldmap$ADMIN[worldmap$ADMIN %in% "Somaliland"] <- "Somaliland Region"
worldmap$ADMIN[worldmap$ADMIN %in% "West Bank"] <- "Palestinian Territories"
worldmap$ADMIN[worldmap$ADMIN %in% "Democratic Republic of the Congo"] <- "Congo (Kinshasa)"
worldmap$ADMIN[worldmap$ADMIN %in% "Republic of the Congo"] <- "Congo (Brazzaville)"
worldmap$ADMIN[worldmap$ADMIN %in% "United Republic of Tanzania"] <- "Tanzania"

writeOGR(obj=worldmap, dsn=finalData, layer="worldmap", driver="ESRI Shapefile")
```

We'll load the map  data using the the readOGR function from the rgdal package. The argument for dsn is the folder where the shapefile is and layer is the name of the shapefile.
```{r, eval=TRUE, warning=FALSE, message=F, results='hide'}
library(rgdal)
worldmap <- readOGR(dsn=finalData, layer="worldmap")
```

```{r, eval=T}
plot(worldmap)
```

## Spatial Data Frame
```{r, eval=F}
print(worldmap)
```

```{r, eval=F}
View(worldmap@data)
```

## Map
```{r, eval=TRUE}
whr <- read.csv(file.path(finalData,"whr_panel.csv"), header = T)
whr <- subset(whr, year == 2015)

worldmap <- merge(worldmap, whr, by.x="ADMIN", by.y="country")
```

## Map2
```{r, eval=TRUE}
library(ggplot2)
library(ggspatial)

ggplot() +
  layer_spatial(data=worldmap, aes(fill = happy_score)) +
  theme_void()
```



## NEXT

First, lets load the world happiness data
```{r, eval=TRUE}
whr <- read.csv(file.path(finalData,"whr_panel.csv"), header = T)
whr <- subset(whr, year == 2015)

worldmap <- readOGR(dsn=finalData, layer="worldmap")

worldmap <- merge(worldmap, whr, by.x="ADMIN", by.y="country")

```


Third, merge the happiness data with the map data
worldmap <- merge(worldmap, whr, by.x="ADMIN", by.y="country")

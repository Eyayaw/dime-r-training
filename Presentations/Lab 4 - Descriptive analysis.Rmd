---
title: "Descriptive analysis"
subtitle: "Field Coordinator Training - R Track"
date: "June 2018"
author: "Luiza Andrade, Leonardo Viotti & Rob Marty "
output:
  beamer_presentation:
    #theme: "Pittsburgh"
    theme: "Madrid"
    colortheme: "whale"
    fonttheme: "default"
    toc: true
    includes:
      in_header: header.tex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo = F, eval=T, include=FALSE}
library(stargazer)
library(openxlsx)


if (Sys.getenv("USERNAME") == "luiza"){
  projectFolder  <- "C:/Users/luiza/Documents/GitHub/dime-r-training"
}

if (Sys.getenv("USERNAME") == "WB501238"){
  projectFolder  <- "C:/Users/WB501238/Documents/GitHub/dime-r-training"
}

if (Sys.getenv("USERNAME") == "Leonardo"){
  projectFolder  <- "C:/Users/Leonardo/Dropbox/Work/WB/Mission/Aug. 2018 Rwanda/NISR R Training"

}

if (Sys.getenv("USERNAME") == "WB519128"){
  projectFolder <- file.path("C:/Users/WB519128/Documents/GitHub/dime-r-training")
}

  # File paths
  Data              <- file.path(projectFolder,"Data")
  rawData           <- file.path(Data,"Raw")
  finalData         <- file.path(Data,"Final")
  Code              <- file.path(projectFolder,"Code")
  Doc               <- file.path(projectFolder,"Documentation")
  Output            <- file.path(projectFolder,"Output")
 

  # Load CSV data
  lwh <- read.csv(file.path(finalData,"lwh_clean.csv"), 
                  header = T)
```

# Introduction
  
## Introduction
  
Descriptive statistics are used to represent the basic features of data. When we talk about descriptive analysis, it usually means that we're not making any assumptions, and we're not using probability theory to infer anything beyond the immediate data.

This session is mostly focused on how to implement descriptive analysis in R. We will not go in depth into these concepts, but you can find some useful references at the end of this presentation.

## Introduction

This session will cover two topics:
  
  \begin{enumerate}
    \item Quick ways to extract summary information from your data
    \item How to use this information to create and export tables
  \end{enumerate}
  

## Introduction

First, let's load the data that is going to be used in the training. 

#### Load the data
```{r, include = T, results = "hide", eval = F}
  # Load CSV data
  lwh <- read.csv(file.path(finalData,"lwh_clean.csv"), 
                  header = T)

```

# Quick summary statistics


## Quick summary statistics


`summary(x, digits)` - equivalent to Stata's *summarize*, displays summary statistics. Its arguments are:

 * **x:** the object you want to summarize, usually a vector or data frame
 * **digits:** the number of decimal digits to be displayed
    
\begin{block}{Exercise 1}
  Use the \texttt{summary()} function to display summary statistics for the \textit{lwh} data frame.
\end{block}

## Quick summary statistics

\scriptsize

```{r, eval = F}
  # Summary statistics
  summary(lwh)
```

```{r, eval = T, echo = F}
  # Summary statistics
  summary(lwh[,1:8])
```
 
## Quick summary statistics
 
 
``table()`` - equivalent to `tabulate` in Stata, creates a frequency table. Its main arguments are the objects to be tabulated.

\begin{block}{Exercise 2}
  Use the \texttt{table()} function to display frequency tables for:
    \begin{enumerate}
      \item The variable \textit{year} in the \textit{lwh} data frame
      \item The variables \textit{gender\_hhh} and \textit{year} in the \textit{lwh} data frame, simultaneously
    \end{enumerate}
\end{block}


## Quick summary statistics
```{r, eval = T}
  # Year of data collection
  table(lwh$year)
```

## Quick summary statistics
```{r, eval = T}
  # Gender of household head per year
  table(lwh$gender_hhh, lwh$year)
```

## Quick summary statistics - Stargazer


 We can also use the \texttt{stargazer()} function to quickly display a nice-looking descriptives table.

  \textit{Stargazer} was originally developed to export beautiful regression tables to \LaTeX\ or html, but it also allows you to generate summary statistics.

## Quick summary statistics - Stargazer

 
### If you haven't yet done this in your master, install and load the ``stargazer`` package now!
 
```{r, eval = F}

  # Install stargazer
  install.packages("stargazer",
                   dependencies = TRUE)

  # Load stargazer
  library(stargazer)
```


## Quick summary statistics - Stargazer

\begin{block}{Exercise 3 - \texttt{stargazer()} summary statistics table}
  Use the \texttt{stargazer()} function  to display summary statistics for the variables in the \textit{lwh} data frame.
\end{block}

  The \texttt{stargazer()} function accepts \textbf{a lot} of arguments, most of which are beyond the scope of this session. Here are the arguments you'll need for this specific table:
  \begin{itemize}
    \item \textbf{x:} the object you want to summarize -- in this case a vector or data frame
    \item \textbf{type:} the output format -- "text" to just display, "latex" (the default) to save as a \LaTeX\ table, and "html" for, yes, html
    \item \textbf{digits:} the number of decimal digits to be displayed
  \end{itemize}

## Quick summary statistics - Stargazer
  \tiny

```{r, eval = F}
# A descriptive table with stargazer
stargazer(lwh, 
          digits = 1, 
          type = "text")

```



```{r, include = T, echo = F}
stargazer(lwh[1:15], 
          digits = 1, 
          type = "text")

```

# Descriptives tables

## Descriptives tables


In R, it is relatively easy to construct any table you can think of by manipulating objects. You can either export an existing data frame or create others taylored to be exported.

Than, it is possible to export them to a myriad of formats. Here, we will focus on exporting tables to Microsoft Excel.

But we'll start by showing a few usefull ways to maniipulate data into exportable formats.


## Descriptives tables

First, we'll construct a table by creating a data.frame 
To construct a table from scratch, we will use two functions:

 - `sapply():` loops through the elements of an object applying a function
 - `data.frame():` creates a data frame object by combining vectors.


## Descriptives tables - sapply()

  ``sapply(X, FUN, ...)``: applies a function to all elements of an object and returns the result in a vector or matrix. Its arguments are:
  
 * *X:* a matrix (or data frame) the function will be applied to
 * *FUN:* the function you want to apply
 * **...:** possible function options

## Descriptives tables - data.frame()

 `data.frame(varName1 = vector1, varName2 = vector2, ...)`: The function `data.frame()` creates data frames, tightly coupled collections of variables which share many of the properties of matrices and of lists, used as the fundamental data structure by most of R's modeling software.
 
 * *varName1:* first column name
 * *vector1:* vector that will be first column 
 * *varName2:*: second column name
 * *vector2:* vector that will be second column 
 
 \hspace{.3cm} . 
 
 \hspace{.3cm} .
 
 \hspace{.3cm} .


## Descriptives tables

Before doing an exercise, lets create a simpler version of the lwh data containg fewer columns:


```{r}
# Vector with covariates to be kept
covariates <- c("age_hhh",
                "num_dependents",
                "income_total_win",
                "expend_food_yearly")

# subset lwh
lwh_simp <- lwh[, covariates]

```


## Descriptives tables

### Exercise 4

 1. Use the \texttt{sapply()} function to create a vector of means for the columns of the \textit{lwh\_simp} data frame.

 2. Create vectors with standard deviations, maximum value, minimum value for the same columns.
    - TIP: set the `na.rm` argument as `TRUE`
 
 3. Use the \texttt{data.frame()} function to combine all 4 vectors chosing column names.

## Descriptives tables
\scriptsize

```{r}
# Create vectors containing descriptives
  meanVec <- sapply(lwh_simp, mean, na.rm = T)
  sdVec <- sapply(lwh_simp, sd, na.rm = T)
  maxVec <- sapply(lwh_simp, max, na.rm = T)
  minVec <- sapply(lwh_simp, min, na.rm = T)
  
  # Combine all created vectors into a dataframe
  lwh_desc <- data.frame( Mean = meanVec,
                          StdDev = sdVec,
                          Max = maxVec,
                          Min = minVec)
  lwh_desc
  
```

## Descriptives tables

### Exercise 4 (Challenge/Bonus)

 1. Now instead of using the `sapply()` function 4 times, use it only once.
 2. You can do this by definining your on function inside the `FUN` argument. Like this:
```{r, eval = F}
 FUN = function(x) { ... anythingYouLikeWith(x) ... }
```
 3. Finally, transpose the result to make it nicer with the function `t()`


## Descriptives tables
\scriptsize

```{r}
lwh_desc2 <- 
  t(
    sapply(lwh_simp, 
           function(x) {
             data.frame(N=sum(!is.na(x)),  # Number of non missings
                        Mean=mean(x, na.rm = T), 
                        StandDev=sd(x, na.rm = T), 
                        Min=min(x, na.rm = T), 
                        Max=max(x, na.rm = T))
             }
           )
    )

lwh_desc2
```

## Descriptives tables
\scriptsize

One thing to notice is that the `lwh_desc2` object is not a data frame, but a matrix. The `sapply()` function outputs vectors or matrices. 

```{r}
class(lwh_desc2)
row.names(lwh_desc2)
colnames(lwh_desc2)
```

## Descriptives tables

The `data.frame()` function is not the only way of creating data frames. There are several other functions that can process existing objects and output a data frame object.

For the next exercises, we'll use two of them:

 * `aggregate()` - Similar to collapse in Stata, it can compute statistics of a variable based on the values of other variable
 * `reshape()` - Reshapes data sets from long to wide and vice-versa

## Descriptives tables - aggregate()

`aggregate(X, by, FUN)`:

 * __x__: a data frame or column
 * __by__: a list of grouping variables
 * __FUN__: a function to compute statistics

## Descriptives tables - aggregate()

\begin{block}{Exercise 5}
 Use the \texttt{aggregate} function to create a data frame called \texttt{year\_inc\_tab} with the mean of the total income per year and treatment status. The syntax of the \texttt{aggregate} function is very similar to that of the \texttt{collapse} function in Stata.
\end{block}

```{r, eval = T, results = "hide"}
# Aggregate income by year and treatment status
year_inc_tab <-
  aggregate(x = lwh$income_total_win, # data.frame
            by = list(year = lwh$year, # list
                      treatment = lwh$treatment_hh),
            FUN = mean) # function
```

Note that the ``income_total_win`` variable is now named ``x`` in the ``income`` data frame

## Descriptives tables - aggregate()
\scriptsize

```{r}
print(year_inc_tab)

```

## Descriptives tables - reshape()

`reshape(data, varying, idvar, timevar, direction)`:

 * __data__: a data frame
 * __idvar__: the variables that identify the group in the wide data set
 * __timevar__: the variable in long format that differentiates multiple records from the same group or individual

## Descriptives tables - reshape()

\begin{block}{Exercise 6}
 Use the \texttt{reshape} function to make the \texttt{year\_inc\_tab} data frame wide per treatment status.
\end{block}


```{r, eval = T, results = "hide"}
# Aggregate income by year and treatment status
year_inc_tab <- reshape(year_inc_tab,
                        idvar = "treatment",
                        timevar = "year",
                        direction = "wide")
```

For comparison, here's how you'd do it in Stata:

``reshape wide x, i(year) j(treatment)``


## Descriptives tables - reshape()
\scriptsize

```{r}
print(year_inc_tab)

```

## Descriptives tables - names()
\scriptsize

Before exporting a data frame, it is often usefull to rename its columns. This can be done using the `names()` function.

The names function retrieves the column names of a data frame as a vector

```{r}
names(lwh_simp)
```

But it can also be used to relaplace the existing names attribute with a new vector. Like this

```{r, eval = F}
names(lwh_simp) <- newNamesVector
```


## Descriptives tables - names()

\begin{block}{Exercise 6}
 Now, use the \texttt{names()} function to rename the columns of \texttt{year\_inc\_tab}.
\end{block}

## Descriptives tables - names()
\scriptsize

```{r}
  names(year_inc_tab) <- c("Treatment Status", 2012, 2013, 2014, 2016, 2018)
```

# Export tables to Excel

## Export tables to Excel

There are several ways to export R objects to Excel. We will use here the the `write.xslx()` function of the `openxlsx` package.

 It takes a matrix or data frame object as input and saves it as a ``.xlsx`` file

`write.xslx()` is one of the most commun functions, but there are many other functions that allow you to export formatted tables to Microsoft Excel, Word or PowerPoint. Here are some examples:

  * ReporteRs
  * Flextable
  * r2excel (only available in GitHub).


## Export tables to Excel

First, install and load the `openxlsx` package:

``` {r, eval = F}
  install.packages("openxlsx", dep = T)
  library(openxlsx)

```

## Export tables to Excel

  `write.xlsx(x, file, row.names = TRUE, col.names ...)` 
  
 * __x__:	the object to be written
 * __file__: where to save the table, i.e., the file path including the file name
 * __row.names__: a logical value indicating whether the row names of x are to be written along with x

## Export tables to Excel

### Exercise 8

Use the `write.xlsx()` function to save the `year_inc_tab` you table created in Exercise 6 into a xlsx file.

1. Set `x` arugment as *year_inc_tab*.
2. Set `row.names` as `FALSE`
4. Set `file` as the folder path to your output folder plus a name for a file plus ".xlsx"

 Tips:

  * Make sure to save it in the *Ouput* folder. You can you the function ``file.path`` to do it
  * Use the help function to check syntax if needed

## Export tables to Excel
\scriptsize

```{r, include = T, eval = F}
  write.xlsx(year_inc_tab,
              file = file.path(Output, "year_inc_tab.xlsx"),
              row.names = F)

```

\begin{figure}[H]
  \centering
  \includegraphics[scale=.8]{img/year_inc_tab_csv.png}
\end{figure}


# References and recommendations

## References and recommendations


  * Johns Hopkins Exploratory Data Analysis at Coursera:
  https://www.coursera.org/learn/exploratory-data-analysis

  * Udacity's Data Analysis with R:
  https://www.udacity.com/course/data-analysis-with-r--ud651

  * Jake Russ stargazer cheat sheet:
  https://www.jakeruss.com/cheatsheets/stargazer/
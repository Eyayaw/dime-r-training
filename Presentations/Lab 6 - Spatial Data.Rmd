---
title: "Spatial Data in R"
author: "DIME"
output: 
  ioslides_presentation:
    transition: 0
    smaller: true
    fig_caption: yes
---

<style>
pre {
  margin-top: -0.2px;
}
post {
  margin-bottom: -0.2px;
}
</style>

<style>
.leaflet-control-layers-selector {
  width: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
GitHub <- "~/GitHub/dime-r-training"
source(file.path(GitHub, "Presentations", "presentations_master.R"))
```

# GIS Overview

## GIS Data
There are two main types of spatial data: vector and raster data. 

* __Vector:__ Vectors (also called shapefiles) consist of points, lines and polygons. These shapes are attached to a dataframe, where each row corresponds to a different spatial element. 

* __Raster:__ Rasters are spatially-referenced grids where each cell has one value.

<br>

<div class="columns-2">
__Shapefile__
```{r fig.align="center", echo=F}
knitr::include_graphics("img/shapefile.png", dpi = 120)
```

__Raster__
```{r fig.align="center", echo=F}
knitr::include_graphics("img/raster.png", dpi = 130)
```
</div>

## Coordinate Reference Systems

* __Coordinate reference systems__ map pairs of numbers to a location on the earth.
* __Geographic Coordinate Systems__ live on a sphere; here, the units are in decimal degrees
  + Using the WGS84 coordinate system the World Bank MC building is located at 38.89 degrees latitude and -77.04 degrees longitude.
* __Projected Coordinate Systems__ project the earth onto a flat surface. Doing this [distorts](http://geoawesomeness.com/5-tools-will-let-master-map-projections/) the earth in some way (shape, area, distance or direction)
  + Using to the World Mercator projection, the World Bank is located 4680364.64 north and -8576320.73 east.

```{r fig.align="center", echo=F}
knitr::include_graphics("img/coordinate_systems.jpg", dpi = 120)
```

## GIS in R System

Here, we'll use the following packages

* __sp:__ Defines classes and methods for spatial objects. 
* __rgdal:__ For processing spatial data, particularly for reading and writing spatial data.
* __rgeos:__ A vector processing library. 
* __raster:__ Reading, writing, manipulating, analyzing and modeling of gridded spatial data.
* __ggmap:__ Load basemaps

```{r fig.align="center", echo=F}
knitr::include_graphics("img/GISsystem.png", dpi = 110)
```


# Displaying GPS data in a map

## Load and Map HH-Level Data
```{r, echo=T, warning=F, message=F}
hh_data <- read.csv(file.path(finalData,"HH_data.csv"))

str(hh_data)
```

## Plot points
```{r, fig.width=5, fig.height=4, fig.align="center"}
library(ggplot2)
ggplot() +
  geom_point(data=hh_data, 
             aes(x=longitude_scramble, y=latitude_scramble),
             size=.7)
```

## Use data in plot aesthetics
```{r, fig.width=5, fig.height=4, fig.align="center"}
library(ggplot2)
ggplot() +
  geom_point(data=hh_data, 
             aes(x=longitude_scramble, y=latitude_scramble, 
                 color=food_security),
             size=.7)
```

## Customize plot
```{r, eval=F, echo=T, warning=F, message=F}

# Launch plot device
ggplot() +
  geom_point(data = hh_data,                   # Add points
             aes(x = longitude_scramble, 
                 y = latitude_scramble, 
                 color = food_security),
             size = .7) +
  coord_quickmap() +                           # Make sure the map doesn't look distorted
  theme_void() +                               # Remove gray color from background
  theme(plot.title = element_text(hjust = 0.5, # Customize title appearance
                                  face="bold")) +
  scale_color_manual(values = c("green", "orange", "red")) +
  labs(title="Household Food Security",        # Add titles
       color="Food Security") 
```

## Customize plot
```{r, eval=T, echo=F, warning=F, message=F}

# Launch plot device
ggplot() +

  # Points
  geom_point(data=hh_data, 
             aes(x=longitude_scramble, y=latitude_scramble, 
                 color=food_security),
             size=.7) +
  
  # Other elements to improve map
  coord_quickmap() + # make sure the map doesn't look distorted. Can also use
                     # coord_map(), but sometimes makes the process slow
  theme_void() +
  scale_color_manual(values=c("green", "orange", "red")) +
  theme(plot.title = element_text(hjust = 0.5, face="bold")) +
  labs(title="Household Food Security", color="Food Security") 
```

## Add a Basemap
```{r, warning = F, message = F, eval = T}
area <- bbox(as.matrix(hh_data[, c("longitude_scramble", "latitude_scramble")]))

basemap <- 
  get_map(location = area,
          zoom = 11,
          maptype = "hybrid") # roadmap, satellite, etc. See help(get_map)

```
```{r, warning = F, message = F, eval = T, echo = F}
plot(basemap)
```


## Add a basemap
```{r, eval = F}
ggmap(basemap) +
  geom_point(data=hh_data,
             aes(x=longitude_scramble,
                 y=latitude_scramble,
                 color=food_security),
             size=.7) +
  coord_quickmap() + # make sure the map doesn't look distorted. Can also use
                     # coord_map(), but sometimes makes the process slow
  theme_void() +
  labs(title="Household Food Security", color="Food Security") +
  theme(plot.title = element_text(hjust = 0.5, face="bold")) +
  scale_color_manual(values=c("green", "orange", "red"))
```

## Add a basemap
```{r, eval = T, echo = F}
ggmap(basemap) +
  geom_point(data=hh_data,
             aes(x=longitude_scramble,
                 y=latitude_scramble,
                 color=food_security),
             size=.7) +
  coord_quickmap() + # make sure the map is not distorted. Can also use
                     # coord_map(), but sometimes makes the process slow
  theme_void() +
  labs(title="Household Food Security", color="Food Security") +
  theme(plot.title = element_text(hjust = 0.5, face="bold")) +
  scale_color_manual(values=c("green", "orange", "red"))
```


# Using Spatial Data Frames

## Spatial Data Frames

The data we used until now is a data set like any other, with GPS coordinates as variables. We're using the GPS coordinates to create a plot with the same command we used before. However, that's not how spatial data is more commonly organized.

Spatial data usually takes the format of a shapefile. A shapefile has three basic components:
1. A shape format, that contains the features' geometry
2. An attribute, that is, a database with information about each shape
3. An index that links the feature geometry to the database

## Loading a shapefile into R

The `get_data` function from the `raster` package allows us to download data from [GADM](https://gadm.org/) (the Database of Global Administrative Areas). Let's download the third administrative division for Rwanda.

```{r}
rwanda_l1 <- getData('GADM', country='RWA', level=1)
rwanda_l1

rwanda_l2 <- getData('GADM', country='RWA', level=2)
```


## Spatial Dataframe Structure
In R, a spatial dataframe is a list, where one element of the list is a dataframe of variables and other is a dataframe of coordinates.

Access a dataframe containing the variables (except the coordinates)
```{r, eval = F}
# Access the dataframe containing the database
rwanda_l1@data
```

```{r, eval = T, echo = F}
# Access the dataframe containing the database
str(rwanda_l1@data)
```


## Quickly Plot Spatial Data
We can quickly plot spatial dataframes.

```{r, warning=F, message=F}
plot(rwanda_l1)
```

## Quickly Plot Spatial Data
We can quickly plot spatial dataframes.

```{r, warning=F, message=F}
plot(rwanda_l1, lwd = 2)
plot(rwanda_l2, add = TRUE)
```

## Making nice-looking maps
As discussed earlier, base plot is useful to create quick visualizations, but not so much for nice presentations.

However, ggplot can't interpret spatial dataframes. Consequently, we need to transform the data into a format that ggplot can understand. Here, we make a dataframe where each vertice of the polygon is an observation.

```{r, warning=F, message=F}
rwanda_l1_df <- tidy(rwanda_l1, region = "ID_1")
rwanda_l2_df <- tidy(rwanda_l2, region = "ID_2")
head(rwanda_l2_df)
```

## Making nice-looking maps

The resulting dataframe from `tidy`:

* Has the variable `id`, which is taken from the the variable in the `region` argument.
* Has
* Doesn't have any of our other variables (e.g., food security).
* We can merge our other variables from the original database into this dataframe using the correspondence in ID variables

```{r}
rwanda_l1_df <- merge(rwanda_l1_df, rwanda_l1, by.x="id", by.y="ID_1")
rwanda_l2_df <- merge(rwanda_l2_df, rwanda_l2, by.x="id", by.y="ID_2")
```

```{r, echo = F}
head(rwanda_l2_df[, 1:6])
```

## Making nice-looking maps

Now, let's make a map
```{r, echo=T, eval = F}
ggplot() + 
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black")
```

## Making nice-looking maps

Now, let's make a map
```{r, echo = F, eval = T}
ggplot() + 
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black")
```

## Making nice-looking maps

Now, let's make a map
```{r, eval = F}
ggplot() + 
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",
               alpha = 0)
```

## Making nice-looking maps

Now, let's make a map
```{r, echo = F}
ggplot() + 
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",
               alpha = 0)
```

## Making nice-looking maps

Now, let's make a map
```{r, echo=T, eval = F}
ggplot() + 
  geom_polygon(data = rwanda_l2_df, 
               aes(x = long, 
                   y = lat,
                   group = group, 
                   fill = id)) +
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",
               alpha = 0,
               lwd = 1.2)
  
```

## Making nice-looking maps

Now, let's make a map
```{r, echo = F}
ggplot() + 
  geom_polygon(data = rwanda_l2_df, 
               aes(x = long, 
                   y = lat,
                   group = group, 
                   fill = id)) +
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",
               alpha = 0,
               lwd = 1.2)
  
```

## Making nice-looking maps


## Making nice-looking maps

```{r, echo = F, warning = F, message = F}
area <- bbox(rwanda_l1)

basemap <- 
  get_map(location = area,
          zoom = 8,
          maptype = "satellite") # roadmap, satellite, etc. See help(get_map)

ggmap(basemap) + 
  geom_polygon(data = rwanda_l2_df, 
               aes(x = long, 
                   y = lat,
                   group = group, 
                   fill = id)) +
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",
               alpha = 0,
               lwd = 1.2)
  
```


## Making nice-looking maps

```{r, echo = F, warning = F, message = F}
ggmap(basemap) + 
  geom_polygon(data = rwanda_l2_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black") +
  geom_polygon(data = rwanda_l2_df, 
               aes(x = long, 
                   y = lat,
                   group = group, 
                   fill = id),
               alpha = .4) +
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",
               alpha = 0,
               lwd = 2) +
  theme_void() + 
  scale_fill_manual(values =  wes_palette(30, name = "Cavalcanti1", type = "continuous"))
  
```

<!-- ## Interactive Maps -->
<!-- So far, we've been making static maps. But those are boring. Let's make an interactive map using [Leaflet](https://rstudio.github.io/leaflet/). There's a bunch of different basemaps to choose from; from the list [here](http://leaflet-extras.github.io/leaflet-providers/preview/), enter the name of the basemap in quotes in the `addProviderTiles` function. -->

<!-- ```{r, eval=T, warning=F, message=F} -->
<!-- library(leaflet) -->
<!-- library(dplyr) -->

<!-- imap_1 <- leaflet() %>% -->
<!--   addProviderTiles("OpenStreetMap") %>% -->
<!--   addCircles(data=hh_data_sdf) -->
<!-- ``` -->

<!-- _NOTE:_ `leaflet` assumes you are using the following coordinate reference system: -->
<!-- ```{r, eval=F} -->
<!-- "+proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0" -->
<!-- ``` -->

<!-- ## -->
<!-- ```{r} -->
<!-- imap_1 -->
<!-- ``` -->

<!-- ## -->
<!-- We can save our interactive map outside of R. Here, we use `saveWidget` from the `htmlwidgets` package. Doubleclicking the html file will open the file in any browser. -->
<!-- ```{r, eval=T, warning=F, message=F} -->
<!-- library(htmlwidgets) -->
<!-- saveWidget(imap_1, file=file.path(Output,"interactive_map.html")) -->
<!-- ``` -->

<!-- ## Lets make a better interactive map -->
<!-- ```{r} -->
<!-- # Define Palette -->
<!-- pal <- colorFactor( -->
<!--   palette = c("Green","Yellow","Red"), -->
<!--   domain = hh_data_sdf$food_security) -->

<!-- imap_2 <- leaflet() %>% -->
<!--   addProviderTiles("Stamen.Terrain") %>% -->
<!--   addCircleMarkers(data=hh_data_sdf, -->
<!--                  radius=3, -->
<!--                  fillOpacity=1, -->
<!--                  color=~pal(food_security), -->
<!--                  stroke=F, # remove outer-circle around circle -->
<!--                  popup=~food_security) %>% # variable to display when click feature -->
<!--   # Add legend for points layer -->
<!--   addLegend(pal = pal, -->
<!--           values = hh_data_sdf$food_security, -->
<!--           title = "Food Security") -->
<!-- ``` -->

<!-- ## -->
<!-- ```{r} -->
<!-- imap_2 -->
<!-- ``` -->


<!-- ## -->
<!-- ggplot can't interpret spatial dataframes. 

<!-- ## Add Polygon to Interactive Map -->
<!-- ```{r} -->
<!-- leaflet() %>% -->
<!--   addProviderTiles("OpenStreetMap") %>% -->
<!--   addPolygons(data=ag_fields) -->
<!-- ``` -->

<!-- ## -->
<!-- ```{r} -->
<!-- pal_foodexpend <- colorNumeric("RdYlGn", ag_fields$expend_food_yearly_mean) -->

<!-- imap_3 <- leaflet() %>% -->
<!--   addProviderTiles("OpenStreetMap") %>% -->
<!--   addPolygons(data=ag_fields, -->
<!--             fillColor = ~pal_foodexpend(expend_food_yearly_mean), -->
<!--             fillOpacity = 0.6, -->
<!--             color="black", # color of line around polygons -->
<!--             weight=1, # width of line around polygons -->
<!--             popup=~site) -->
<!-- ``` -->

<!-- ## -->
<!-- ```{r} -->
<!-- imap_3 -->
<!-- ``` -->


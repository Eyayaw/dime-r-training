---
title: "Spatial Data in R"
author: "DIME"
output: 
  ioslides_presentation:
    transition: 0
    smaller: true
    fig_caption: yes
---

<style>
pre {
  margin-top: -0.2px;
}
post {
  margin-bottom: -0.2px;
}
</style>

<style>
.leaflet-control-layers-selector {
  width: auto;
}
</style>

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
GitHub <- "~/GitHub/dime-r-training"
source(file.path(GitHub, "Presentations", "presentations_master.R"))
```

# GIS Overview

## GIS Data
There are two main types of spatial data: vector and raster data. 

* __Vector:__ Vectors (also called shapefiles) consist of points, lines and polygons. These shapes are attached to a dataframe, where each row corresponds to a different spatial element. 

* __Raster:__ Rasters are spatially-referenced grids where each cell has one value.

<br>

<div class="columns-2">
__Shapefile__
```{r fig.align="center", echo=F}
knitr::include_graphics("img/shapefile.png", dpi = 120)
```

__Raster__
```{r fig.align="center", echo=F}
knitr::include_graphics("img/raster.png", dpi = 130)
```
</div>

## Coordinate Reference Systems

* __Coordinate reference systems__ map pairs of numbers to a location on the earth.
* __Geographic Coordinate Systems__ live on a sphere; here, the units are in decimal degrees
  + Using the WGS84 coordinate system the World Bank Rwanda is located at -1.951 degrees latitude and 30.061 degrees longitude.
* __Projected Coordinate Systems__ project the earth onto a flat surface. Doing this [distorts](http://geoawesomeness.com/5-tools-will-let-master-map-projections/) the earth in some way (shape, area, distance or direction)
  + Using to the World Mercator projection, the World Bank is located 9783995.88 north and 173093.46 east.

```{r fig.align="center", echo=F}
knitr::include_graphics("img/coordinate_systems.jpg", dpi = 120)
```

## GIS in R System

Here, we'll use the following packages

* __sp:__ Defines classes and methods for spatial objects. 
* __rgdal:__ For processing spatial data, particularly for reading and writing spatial data.
* __rgeos:__ A vector processing library. 
* __raster:__ Reading, writing, manipulating, analyzing and modeling of gridded spatial data.
* __ggmap:__ Load basemaps

```{r fig.align="center", echo=F}
knitr::include_graphics("img/GISsystem.png", dpi = 110)
```



# Getting started

## Getting started

1. Run your master file to load packages and set folder paths
2. Open a new script for the code in this session
3. Load the data for this session


```{r, echo=T, warning=F, message=F}
# Loading the data
hh_data <- read.csv(file.path(finalData,"HH_data.csv"))

str(hh_data)
```

# Displaying GPS data in a map

## Displaying GPS data in a map
* In this data set, we have coordinates for the location of each household in our sample
* We can plot the longitude and latitude in a map as points, the same way we would with any other numeric variable
* To do so, we'll keep using ggplot:

```{r, eval = F}
# Plot household coordinates from data set
ggplot() +
  geom_point(data = hh_data, 
             aes(x = longitude_scramble, 
                 y = latitude_scramble),
             size = .7)
```

## Displaying GPS data in a map
```{r, fig.width=5, fig.height=4, fig.align="center"}
# Plot household coordinates from data set
ggplot() +
  geom_point(data = hh_data, 
             aes(x = longitude_scramble, 
                 y = latitude_scramble),
             size = .7)
```

## Displaying GPS data in a map
* In a regular plot we may want to adjust the scale to the data
* In a map, however, it's important to avoid distortion so it can be recognized 
* The option ``coord_map()`` creates an approximated projection of an area
* ``coord_map()`` works best for smaller areas closer to the equator
* A more precise (and less efficient) projection can be created by ``coord_map()``

```{r, eval = F}
# Plot undistorted household coordinates from data set
ggplot() +
  geom_point(data = hh_data, 
             aes(x = longitude_scramble, 
                 y = latitude_scramble),
             size = .7) +
  coord_quickmap()
```

## Displaying GPS data in a map
```{r}
# Plot undistorted household coordinates from data set
ggplot() +
  geom_point(data = hh_data, 
             aes(x = longitude_scramble, 
                 y = latitude_scramble),
             size = .7) +
  coord_quickmap()
```

## Use data in plot aesthetics

* Because we have other information about the households, we can use the map to illustrate the
geographic districution of the variables in the data set

* This is done using the same arguments as we used for non-spatial data: 

```{r, eval = F}
# Plot undistorted household coordinates from data set
ggplot() +
  geom_point(data = hh_data, 
             aes(x = longitude_scramble, 
                 y = latitude_scramble,
                 color = food_security),
             size = .7) +
  coord_quickmap()
```

## Use data in plot aesthetics

```{r, echo = F}
# Plot undistorted household coordinates from data set
ggplot() +
  geom_point(data = hh_data, 
             aes(x = longitude_scramble, 
                 y = latitude_scramble,
                 color = food_security),
             size = .7) +
  coord_quickmap()
```

## Customize plot
Now let's make a few adjustments to make it better-looking:

1. Remove the ticks and axis titles
2. Show little hunger in green, moderate in yellow and severe in red
3. Add a title to the map and to the legend

```{r, eval=F, echo=T, warning=F, message=F}

# Launch plot device
ggplot() +
  geom_point(data = hh_data,                   # Add points
             aes(x = longitude_scramble, 
                 y = latitude_scramble, 
                 color = food_security),
             size = .7) +
  coord_quickmap() +                           # Make sure the map isn't distorted
  theme_void() +                               # Remove gray color from background
  scale_color_manual(values = c("green",       # Use more intuitive colors
                                "orange",
                                "red")) +
  labs(title="Household Food Security",        # Add titles
       color="Food Security") 
```

## Customize plot
```{r, eval=T, echo=F, warning=F, message=F}

# Launch plot device
ggplot() +
  geom_point(data = hh_data,                   # Add points
             aes(x = longitude_scramble, 
                 y = latitude_scramble, 
                 color = food_security),
             size = .7) +
  coord_quickmap() +                           # Make sure the map isn't distorted
  theme_void() +                               # Remove gray color from background
  scale_color_manual(values = c("green",       # Set colors so they're more intuitive
                                "orange",
                                "red")) +
  labs(title="Household Food Security",        # Add titles
       color="Food Security") 
```

## Add a Basemap

* Ok, we know we are using spatial data, but this does not look like a map
* Let's add a basemap on the background
* To do so, we will use a function called ``get_map``, that loads into R a map from a server such as Google Maps

### ``get_map``: 
* **``location``**: an address, longitude/latitude pair (in that order), or left/bottom/right/top bounding box
* **``zoom``**: from 3 (continent) to 21 (building)
* **``maptype``**: the map look

## Add a Basemap

```{r, warning = F, message = F, eval = T}
# Choose a point to center the map on
centroid <-  c(30.46586, -2.014172)


# Get map
basemap <- get_map(location = centroid,
                   zoom = 11,
                   maptype = "hybrid")
```
```{r, echo = F}
plot(basemap)
```

## Add a Basemap

<div class="columns-2">
  __maptype = "roadmap"__
```{r fig.align="center", echo=F}
knitr::include_graphics("img/roadmap.png", dpi = 300)
```
  __maptype = "satellite"__
```{r fig.align="center", echo=F}
knitr::include_graphics("img/satellite.png", dpi = 300)
```
  __maptype = "toner"__
```{r fig.align="center", echo=F}
knitr::include_graphics("img/tonar.png", dpi = 300)
```
  __maptype = "watercolor"__
```{r fig.align="center", echo=F}
knitr::include_graphics("img/watercolor.png", dpi = 300)
```

## Add a basemap

To use the basemap on the background of our map, we replace the `ggplot()` expression in the regular graph with `ggmap()`:

```{r, eval = F}
ggmap(basemap) +                               # Load basemap 
  geom_point(data = hh_data,                   # Add points
             aes(x = longitude_scramble, 
                 y = latitude_scramble, 
                 color = food_security),
             size = .7) +
  coord_quickmap() +                           # Make sure the map isn't distorted
  theme_void() +                               # Remove gray color from background
  scale_color_manual(values = c("green",       # Set colors so they're more intuitive
                                "orange",
                                "red")) +
  labs(title="Household Food Security",        # Add titles
       color="Food Security") 
```

## Add a basemap
```{r, eval = T, echo = F}
ggmap(basemap) +
  geom_point(data = hh_data,                   # Add points
             aes(x = longitude_scramble, 
                 y = latitude_scramble, 
                 color = food_security),
             size = .7) +
  coord_quickmap() +                           # Make sure the map isn't distorted
  theme_void() +                               # Remove gray color from background
  scale_color_manual(values = c("green",       # Set colors so they're more intuitive
                                "orange",
                                "red")) +
  labs(title="Household Food Security",        # Add titles
       color="Food Security") 
```


# Using Spatial Data Frames

## Spatial Data Frames

The data we used until now is a data set like any other, with GPS coordinates as variables. We're using the GPS coordinates to create a plot with the same command we used before. However, that's not how spatial data is more commonly organized.

Spatial data usually takes the format of a shapefile. A shapefile has three basic components:

1. A shape format, that contains the features' geometry
2. An attribute, that is, a database with information about each shape
3. An index that links the feature geometry to the database

## Loading a shapefile into R

The `get_data` function from the `raster` package allows us to download data from [GADM](https://gadm.org/) (the Database of Global Administrative Areas). Let's download the first an second administrative division for Rwanda:

```{r}
# First administrative division
rwanda_l1 <- getData('GADM', country='RWA', level=1)
rwanda_l1

# Second administrative division
rwanda_l2 <- getData('GADM', country='RWA', level=2)
```


## Spatial Dataframe Structure
In R, a spatial dataframe is a list, where one element of the list is a dataframe of variables and other is a dataframe of coordinates.

Access a dataframe containing the variables (except the coordinates)
```{r, eval = F}
# Access the dataframe containing the database
rwanda_l1@data
```

```{r, eval = T, echo = F}
# Access the dataframe containing the database
str(rwanda_l1@data)
```


## Quickly Plot Spatial Data
We can quickly plot spatial dataframes using base plot. Note that now the map is not distorted even though we didn't tell it to project the data.

```{r, warning=F, message=F}
# Quick plot of Rwanda's first administrative division
plot(rwanda_l1)
```

## Quickly Plot Spatial Data
We can quickly plot spatial dataframes.

```{r, warning=F, message=F}
# Quick plot of Rwanda's first and second administrative divisions
plot(rwanda_l1, lwd = 2)
plot(rwanda_l2, add = TRUE)
```

## Making nice-looking maps
As discussed earlier, base plot is useful to create quick visualizations, but not so much for nice presentations.

However, `ggplot` can't interpret spatial dataframes. Consequently, we need to transform the data into a format that ggplot can understand. Here, we make a dataframe where each vertice of the polygon is an observation.

```{r, warning=F, message=F}
# Transform the sshapefile into a data set
rwanda_l1_df <- tidy(rwanda_l1, region = "ID_1")
rwanda_l2_df <- tidy(rwanda_l2, region = "ID_2")
head(rwanda_l2_df)
```

## Making nice-looking maps

The resulting dataframe from `tidy`:

* Has the variable `id`, which is taken from the the variable in the `region` argument.
* Doesn't have any of our other variables (e.g., food security).
* We can merge our other variables from the original database into this dataframe using the correspondence in ID variables

```{r}
  # Merging spatial data and original data set
  rwanda_l1_df <- merge(rwanda_l1_df, rwanda_l1, 
                        by.x="id", by.y="ID_1")
  
  rwanda_l2_df <- merge(rwanda_l2_df, rwanda_l2, 
                        by.x="id", by.y="ID_2")
```

```{r, echo = F}
head(rwanda_l2_df[, c(1,2,3,4,5,6,10,12,13)])
```

## Making nice-looking maps

Now, let's make a map
```{r, echo=T, eval = F}
# Map first administrative division
ggplot() + 
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black")    # Set color of line
   
```

## Making nice-looking maps

Now, let's make a map
```{r, echo = F, eval = T}
ggplot() + 
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black") 
```

## Making nice-looking maps

* The argument `alpha` determines the transparency of the map's fill:

```{r, eval = F}
ggplot() + 
  geom_polygon(data = rwanda_l1_df,   ## Map first administrative division
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",       # Set color of line
               alpha = 0)              # Set transparency of fill
```

## Making nice-looking maps

* The argument `alpha` determines the transparence of the map's fill:
```{r, echo = F}
ggplot() + 
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",
               alpha = 0)
```

## Using two shapefiles in a single map

To make it more interesting, let's also show the second administrative division. We do this by adding a second shapefile to the same plot:

```{r, echo=T, eval = F}
ggplot() +                             ## Open graph device
  geom_polygon(data = rwanda_l2_df,    ## Map second administrative division
               aes(x = long, 
                   y = lat,
                   group = group, 
                   fill = id),          # One color fill per id
               alpha = .3) +            # Set transparence of fill
  geom_polygon(data = rwanda_l1_df,    ## Map first administrative division
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",         # Set color of line
               alpha = 0)                # Set transparence of fill
  
```

## Using two shapefiles in a single map

```{r, echo = F}
ggplot() + 
  geom_polygon(data = rwanda_l2_df, 
               aes(x = long, 
                   y = lat,
                   group = group, 
                   fill = id)) +
  geom_polygon(data = rwanda_l1_df, 
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",
               alpha = 0)
  
```


## Adding a basemap

Now let's add another basemap 
```{r, eval = F, warning = F, message = F}
# Create a bounding box around Rwanda
area <- bbox(rwanda_l1)                 # bbox() only works with spatial data

# Get the basemap from Google Maps
basemap <- get_map(location = area,
                   zoom = 8,
                   maptype = "satellite")

# Create the map
ggmap(basemap) + 
  geom_polygon(data = rwanda_l2_df,    ## Map second administrative division
               aes(x = long, 
                   y = lat,
                   group = group, 
                   fill = id),          # One color fill per id
               alpha = .3) +            # Set transparence of fill
  geom_polygon(data = rwanda_l1_df,    ## Map first administrative division
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",         # Set color of line
               alpha = 0)                # Set transparence of fill
  
```

## Adding a basemap

```{r, echo = F, warning = F, message = F}
# Create a bounding box around Rwanda
area <- bbox(rwanda_l1)

# Get the basemap from Google Maps
basemap <- 
  get_map(location = area,
          zoom = 8,
          maptype = "satellite")

# Create map
ggmap(basemap) +                       ## Add basemap
  geom_polygon(data = rwanda_l2_df,    ## Map second administrative division
               aes(x = long, 
                   y = lat,
                   group = group, 
                   fill = id),          # One color fill per id
               alpha = .3) +            # Set transparence of fill
  geom_polygon(data = rwanda_l1_df,    ## Map first administrative division
               aes(x = long, 
                   y = lat,
                   group = group),
               colour = "black",         # Set color of line
               alpha = 0)                # Set transparence of fill
  
```

## Final adjustments

Some final touches to make it prettier:
```{r, eval = F, warning = F, message = F}
ggmap(basemap) +                         ## Add basemap
  geom_polygon(data = rwanda_l2_df,      ## Map second administrative division
               aes(x = long,
                   y = lat,
                   group = group,
                   fill = id),            # One color fill per id
               alpha = .2) +              # Set transparence of fill
  geom_polygon(data = rwanda_l1_df,      ## Map first administrative division
               aes(x = long,
                   y = lat,
                   group = group),
               colour = "black",          # Set color of line
               alpha = 0) +               # Set transparence of fill
  coord_fixed(xlim = c(28.8, 31),         # Crop map to remove unnecessary borders
              ylim = c(-3,-1)) +
  theme_void() +                          # Remove ticks
  theme(legend.position = "none")         # Remove legend
```

## Final adjustments

```{r, echo = F, warning = F, message = F}
ggmap(basemap) +                         ## Add basemap
  geom_polygon(data = rwanda_l2_df,      ## Map second administrative division
               aes(x = long,
                   y = lat,
                   group = group,
                   fill = id),            # One color fill per id
               alpha = .2) +              # Set transparence of fill
  geom_polygon(data = rwanda_l1_df,      ## Map first administrative division
               aes(x = long,
                   y = lat,
                   group = group),
               colour = "black",          # Set color of line
               alpha = 0) +               # Set transparence of fill
  coord_fixed(xlim = c(28.8, 31), 
              ylim = c(-3,-1)) +
  theme_void() +                          # Remove ticks
  theme(legend.position = "none")         # Remove legend
```